<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ AI</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@1.5.10/css/pico.min.css">
    
    <style>
        body { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .nav-tabs { display: flex; gap: 10px; border-bottom: 2px solid #e0e0e0; margin-bottom: 20px; }
        .nav-btn { background: none; border: none; padding: 10px 20px; font-size: 1.1rem; color: #666; cursor: pointer; border-radius: 8px 8px 0 0; transition:0.3s; }
        .nav-btn:hover { background: #f0f0f0; }
        .nav-btn.active { background: #1095c1; color: white; font-weight: bold; }
        .tab-content { display: none; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }
        
        /* CSS ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏ö‡∏•‡∏≠‡∏¢‡∏ó‡∏±‡∏ö‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ */
        .cam-wrapper { 
            position: relative; width: 640px; height: 480px; background: #000; margin: 0 auto; border-radius: 10px; overflow: hidden; 
            display: flex; justify-content: center; align-items: center;
        }
        video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        canvas { position: absolute; top: 0; left: 0; z-index: 10; } /* canvas ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î */

        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.9em; font-weight: bold; }
        .present { background: #d4edda; color: #155724; }
        .absent { background: #f8d7da; color: #721c24; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <nav><ul><li><strong>üè´ AI Face Attendance</strong></li></ul><ul><li id="aiStatus" style="color:orange;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î AI...</li></ul></nav>

    <div class="nav-tabs">
        <button class="nav-btn active" onclick="setTab('scan', event)">üì∏ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</button>
        <button class="nav-btn" onclick="setTab('register', event)">üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
        <button class="nav-btn" onclick="setTab('dashboard', event)">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
    </div>

    <div id="scan" class="tab-content active">
        <article>
            <div class="grid">
                <div>
                    <label>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô <input type="text" id="scanClassId" value="TestClass"></label>
                    <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <input type="date" id="scanDate"></label>
                    <button onclick="loadStudents()" id="btnLoad">1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    <button onclick="startScan()" id="btnStartScan" disabled class="secondary">2. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô</button>
                </div>
                <div style="height:300px; overflow-y:auto; border:1px solid #ccc; padding:10px; background:#f9f9f9;">
                    <h6>üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</h6><div id="scanLog"></div>
                </div>
            </div>
            <div class="cam-wrapper" id="scanCamBox" style="margin-top:20px;">
                <video id="scanVideo" autoplay muted playsinline></video>
            </div>
        </article>
    </div>

    <div id="register" class="tab-content">
        <article>
            <div class="grid">
                <div>
                    <label>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô <input type="text" id="regClassId"></label>
                    <label>‡∏£‡∏´‡∏±‡∏™ <input type="text" id="regId"></label>
                    <label>‡∏ä‡∏∑‡πà‡∏≠ <input type="text" id="regName"></label>
                    <button onclick="registerFace()" id="btnReg" disabled>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <p id="regStatus"></p>
                </div>
                <div>
                    <div class="cam-wrapper" id="regCamBox" style="width:100%; height:350px;">
                        <video id="regVideo" autoplay muted playsinline></video>
                    </div>
                    <button onclick="startRegCamera()" class="outline" style="width:100%; margin-top:10px;">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                </div>
            </div>
        </article>
    </div>

    <div id="dashboard" class="tab-content">
        <article>
            <div class="grid" style="align-items:end;">
                <label>‡∏´‡πâ‡∏≠‡∏á <input type="text" id="dashClass" value="TestClass"></label>
                <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <select id="dashDate"><option value="">-- ‡∏£‡∏ß‡∏° --</option></select></label>
                <button onclick="loadReport()">üîç ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
            </div>
            <div style="overflow-x:auto; margin-top:20px;">
                <table role="grid"><thead id="dashHead"></thead><tbody id="dashBody"></tbody></table>
            </div>
        </article>
    </div>

    <script>
        // üî•üî•üî• ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ URL_APPS_SCRIPT_... üî•üî•üî•
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby5Icavnzqn8PdDznQYGh5H93FgGbru21GKFDuJRyqJEy6sFHHzYnOMNqhsG96NY0B5kg/exec'; 
        
        const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
        let faceMatcher = null, currentStream = null, isModelReady = false, reportData = null;
        let checkedStudents = new Set(); // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß

        // --- INIT ---
        window.onload = async () => {
            document.getElementById('scanDate').valueAsDate = new Date();
            try {
                await Promise.all([
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                isModelReady = true;
                document.getElementById('aiStatus').innerHTML = "‚úÖ AI ‡∏û‡∏£‡πâ‡∏≠‡∏°";
                document.getElementById('aiStatus').style.color = "green";
            } catch (e) { console.error(e); }
        };

        // --- TABS ---
        function setTab(tabId, event) {
            stopCamera();
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if(event) event.currentTarget.classList.add('active');
        }

        function stopCamera() {
            if (currentStream) currentStream.getTracks().forEach(t => t.stop());
            document.querySelectorAll('video').forEach(v => v.srcObject = null);
            document.querySelectorAll('canvas').forEach(c => c.remove());
        }

        // --- SCAN ---
        async function loadStudents() {
            const classId = document.getElementById('scanClassId').value;
            const btn = document.getElementById('btnLoad'); btn.textContent = "‚è≥..."; btn.disabled = true;
            try {
                const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "getStudents", classId }) });
                const data = await res.json();
                if (data.status === "success" && data.students.length > 0) {
                    const labeled = data.students.map(s => new faceapi.LabeledFaceDescriptors(s.name, [new Float32Array(JSON.parse(s.descriptors))]));
                    faceMatcher = new faceapi.FaceMatcher(labeled, 0.6);
                    
                    checkedStudents.clear();
                    data.students.forEach(s => { if(s.isChecked) checkedStudents.add(s.name); });

                    alert(`‡πÇ‡∏´‡∏•‡∏î ${data.students.length} ‡∏Ñ‡∏ô (‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß ${checkedStudents.size} ‡∏Ñ‡∏ô)`);
                    document.getElementById('btnStartScan').disabled = false;
                } else { alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"); }
            } catch (e) { alert("Error: " + e); }
            btn.textContent = "1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"; btn.disabled = false;
        }

        async function startScan() {
            stopCamera();
            const video = document.getElementById('scanVideo');
            const camBox = document.getElementById('scanCamBox');

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                currentStream = stream;
                video.srcObject = stream;
                await new Promise(r => video.onloadedmetadata = r);
                video.play();
                while (video.videoWidth === 0) await new Promise(r => setTimeout(r, 100));

                const canvas = faceapi.createCanvasFromMedia(video);
                camBox.append(canvas);
                const size = { width: video.videoWidth, height: video.videoHeight };
                faceapi.matchDimensions(canvas, size);

                setInterval(async () => {
                    if (!isModelReady || video.paused || video.ended) return;
                    const detections = await faceapi.detectAllFaces(video).withFaceLandmarks().withFaceDescriptors();
                    const resized = faceapi.resizeResults(detections, size);
                    canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);

                    resized.forEach(d => {
                        let label = "Checking...", boxColor = "blue";
                        if (faceMatcher) {
                            const best = faceMatcher.findBestMatch(d.descriptor);
                            if (best.label === "unknown") { label = "‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å"; boxColor = "orange"; }
                            else {
                                if (checkedStudents.has(best.label)) {
                                    label = "‚õî ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß (" + best.label + ")"; boxColor = "red";
                                } else {
                                    label = "‚úÖ " + best.toString(); boxColor = "#00ff00";
                                    checkedStudents.add(best.label);
                                    logCheckIn(best.label);
                                }
                            }
                        }
                        new faceapi.draw.DrawBox(d.detection.box, { label, boxColor }).draw(canvas);
                    });
                }, 100);
            } catch (e) { alert("Cam Error: " + e.message); }
        }

        function logCheckIn(name) {
            const time = new Date().toLocaleTimeString('th-TH');
            document.getElementById('scanLog').innerHTML = `<div style="color:green">‚úÖ ${time} - ${name}</div>` + document.getElementById('scanLog').innerHTML;
            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "checkIn", classId: document.getElementById('scanClassId').value, date: document.getElementById('scanDate').value, id: name }) });
        }

        // --- REGISTER ---
        async function startRegCamera() {
            stopCamera();
            const video = document.getElementById('regVideo');
            const camBox = document.getElementById('regCamBox');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                currentStream = stream; video.srcObject = stream;
                await new Promise(r => video.onloadedmetadata = r); video.play();
                while (video.videoWidth === 0) await new Promise(r => setTimeout(r, 100));

                const canvas = faceapi.createCanvasFromMedia(video); camBox.append(canvas);
                const size = { width: video.videoWidth, height: video.videoHeight };
                faceapi.matchDimensions(canvas, size);

                setInterval(async () => {
                    if (!isModelReady || video.paused) return;
                    const det = await faceapi.detectSingleFace(video).withFaceLandmarks();
                    canvas.getContext('2d').clearRect(0,0,canvas.width,canvas.height);
                    if(det) new faceapi.draw.DrawBox(faceapi.resizeResults(det, size).detection.box, { label: "Ready", boxColor: "blue" }).draw(canvas);
                }, 100);
                document.getElementById('btnReg').disabled = false;
            } catch (e) { alert("Cam Error"); }
        }

        async function registerFace() {
            const video = document.getElementById('regVideo');
            const btn = document.getElementById('btnReg');
            const stat = document.getElementById('regStatus');
            btn.disabled = true; stat.innerHTML = "‚è≥...";
            try {
                const det = await faceapi.detectSingleFace(video).withFaceLandmarks().withFaceDescriptor();
                if (!det) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡πâ‡∏≤");
                await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "register", classId: document.getElementById('regClassId').value, id: document.getElementById('regId').value, name: document.getElementById('regName').value, prefix: "", no: "", descriptors: JSON.stringify(Array.from(det.descriptor)) }) });
                stat.innerHTML = "‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"; stat.style.color = "green";
                setTimeout(() => { stat.innerHTML = ""; btn.disabled = false; }, 2000);
            } catch (e) { stat.innerHTML = "‚ùå " + e.message; btn.disabled = false; }
        }

        // --- REPORT ---
        async function loadReport() {
            const cls = document.getElementById('dashClass').value;
            const tbody = document.getElementById('dashBody'); tbody.innerHTML = "Loading...";
            try {
                const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "getReport", classId: cls }) });
                reportData = await res.json();
                const sel = document.getElementById('dashDate');
                if (sel.options.length === 1) reportData.dates.forEach(d => sel.add(new Option(d, d)));
                renderTable();
            } catch (e) { tbody.innerHTML = "Error"; }
        }

        function renderTable() {
            const date = document.getElementById('dashDate').value;
            const thead = document.getElementById('dashHead');
            const tbody = document.getElementById('dashBody');
            let html = "";
            
            if (date) {
                thead.innerHTML = `<tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (${date})</th></tr>`;
                reportData.students.forEach(s => {
                    const st = s.attendance[date] || "‡∏Ç‡∏≤‡∏î";
                    html += `<tr><td>${s.name}</td><td><span class="status-badge ${st!=='‡∏Ç‡∏≤‡∏î'?'present':'absent'}">${st!=='‡∏Ç‡∏≤‡∏î'?'‚úÖ '+st:'‚ùå ‡∏Ç‡∏≤‡∏î'}</span></td></tr>`;
                });
            } else {
                let h = "<tr><th>‡∏ä‡∏∑‡πà‡∏≠</th>";
                reportData.dates.forEach(d => h += `<th>${d.split('/')[0]}/${d.split('/')[1]}</th>`);
                thead.innerHTML = h + "</tr>";
                reportData.students.forEach(s => {
                    html += `<tr><td>${s.name}</td>`;
                    reportData.dates.forEach(d => html += `<td>${(s.attendance[d] && s.attendance[d] !== "‡∏Ç‡∏≤‡∏î") ? '‚úÖ' : '‚ùå'}</td>`);
                    html += "</tr>";
                });
            }
            tbody.innerHTML = html;
        }
        document.getElementById('dashDate').onchange = renderTable;
    </script>
</body>
</html>
