<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ (AI Face Attendance)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <style>
        :root {
            --primary: #4e54c8;
            --secondary: #8f94fb;
            --success: #2ecc71;
            --bg-grad: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Prompt', sans-serif;
            background: var(--bg-grad);
            margin: 0; padding: 20px;
            min-height: 100vh;
            display: flex; justify-content: center; align-items: flex-start;
        }

        .app-container {
            background: var(--card-bg);
            width: 100%; max-width: 1100px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            padding: 30px;
            margin-top: 20px;
        }

        /* --- Header & Nav --- */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; }
        h1 { margin: 0; color: var(--primary); font-size: 1.6rem; }
        .ai-status { font-size: 0.9rem; font-weight: 600; padding: 6px 15px; border-radius: 20px; background: #eee; color: #777; }
        .ai-status.ready { background: #d4edda; color: #155724; }

        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; background: #f1f3f5; padding: 5px; border-radius: 12px; }
        .nav-btn {
            flex: 1; border: none; background: transparent; padding: 12px;
            font-family: 'Prompt', sans-serif; font-size: 1rem; color: #666;
            cursor: pointer; border-radius: 10px; transition: 0.3s;
        }
        .nav-btn.active { background: white; color: var(--primary); font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        .tab-content { display: none; animation: slideUp 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Mode Switcher (New Feature) --- */
        .mode-switch {
            display: flex; gap: 10px; margin-bottom: 20px;
        }
        .mode-btn {
            flex: 1; padding: 10px; border: 2px solid #e0e0e0; background: white;
            border-radius: 10px; cursor: pointer; color: #888; font-family: 'Prompt';
            transition: 0.3s;
        }
        .mode-btn.active {
            border-color: var(--primary); color: var(--primary); background: #eef0ff; font-weight: bold;
        }
        .mode-btn:hover { border-color: #ccc; }

        /* --- Inputs & Camera --- */
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 0.9rem; }
        input, select {
            width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 10px;
            font-family: 'Prompt', sans-serif; font-size: 1rem; box-sizing: border-box;
        }
        input:focus { border-color: var(--secondary); outline: none; }
        input[readonly] { background-color: #f0f2f5; color: #777; cursor: not-allowed; }

        .btn {
            border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer;
            font-family: 'Prompt', sans-serif; font-size: 1rem; font-weight: 600;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.2s; width: 100%; color: white;
        }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-success { background: linear-gradient(135deg, #2af598 0%, #009efd 100%); }
        .btn-info { background: #17a2b8; }
        .btn-secondary { background: #6c757d; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }

        .cam-wrapper {
            position: relative; width: 100%; max-width: 640px; height: 480px;
            background: #000; border-radius: 15px; overflow: hidden;
            margin: 0 auto; border: 4px solid #fff; box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 10; }

        /* --- Search & Grid --- */
        .search-box { background: #e3f2fd; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #90caf9; }
        .search-flex { display: flex; gap: 10px; }
        .grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        @media (max-width: 768px) { .grid-layout { grid-template-columns: 1fr; } }
        
        /* Table & Logs */
        .log-box { height: 350px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 10px; padding: 10px; background: #fafafa; }
        .log-item { padding: 8px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #555; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-danger { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <h1><i class="fas fa-camera-retro"></i> Face Check System</h1>
        <div id="aiStatus" class="ai-status"><i class="fas fa-spinner fa-spin"></i> Loading AI...</div>
    </header>

    <div class="nav-tabs">
        <button class="nav-btn active" onclick="setTab('scan', event)"><i class="fas fa-qrcode"></i> ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ (Scan)</button>
        <button class="nav-btn" onclick="setTab('register', event)"><i class="fas fa-user-edit"></i> ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (Register)</button>
        <button class="nav-btn" onclick="setTab('dashboard', event)"><i class="fas fa-chart-pie"></i> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (Dashboard)</button>
    </div>

    <div id="scan" class="tab-content active">
        <div class="grid-layout">
            <div>
                <div class="input-group">
                    <label>üè´ ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                    <input type="text" id="scanClassId" value="TestClass">
                </div>
                <div class="input-group">
                    <label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</label>
                    <input type="date" id="scanDate">
                </div>
                <div style="display: flex; gap: 10px; margin-top:20px;">
                    <button onclick="loadStudents()" id="btnLoad" class="btn btn-info">
                        <i class="fas fa-cloud-download-alt"></i> 1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                    <button onclick="startScan()" id="btnStartScan" disabled class="btn btn-primary">
                        <i class="fas fa-play"></i> 2. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô
                    </button>
                </div>
                <div style="margin-top: 20px;">
                    <label>üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (Real-time)</label>
                    <div id="scanLog" class="log-box"></div>
                </div>
            </div>
            <div>
                <div class="cam-wrapper" id="scanCamBox">
                    <video id="scanVideo" autoplay muted playsinline></video>
                    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:white; z-index:0;">
                        <i class="fas fa-video-slash" style="font-size:3rem; opacity:0.3;"></i>
                    </div>
                </div>
                <p style="text-align:center; color:#666; margin-top:10px;"><small>‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß=‡∏ú‡πà‡∏≤‡∏ô | ‡∏™‡∏µ‡πÅ‡∏î‡∏á=‡∏ã‡πâ‡∏≥</small></p>
            </div>
        </div>
    </div>

    <div id="register" class="tab-content">
        <div class="grid-layout">
            <div>
                <div class="mode-switch">
                    <button class="mode-btn active" onclick="setRegMode('existing', this)">
                        <i class="fas fa-search"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß)
                    </button>
                    <button class="mode-btn" onclick="setRegMode('new', this)">
                        <i class="fas fa-user-plus"></i> ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠)
                    </button>
                </div>

                <div id="existingSearchBox" class="search-box">
                    <label style="color:#1565c0;"><i class="fas fa-database"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label>
                    <div class="search-flex">
                        <input type="text" id="regClassId" placeholder="‡∏´‡πâ‡∏≠‡∏á (‡πÄ‡∏ä‡πà‡∏ô 1-1)" value="TestClass">
                        <input type="text" id="regSearchId" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (001)">
                        <button onclick="findStudentData()" class="btn btn-secondary" style="width: auto;">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>

                <div class="input-group">
                    <label>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                    <input type="text" id="regId" readonly placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
                </div>
                <div class="input-group">
                    <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                    <input type="text" id="regName" readonly placeholder="‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
                </div>

                <button onclick="registerFace()" id="btnReg" disabled class="btn btn-success" style="margin-top:15px;">
                    <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤
                </button>
                <p id="regStatus" style="text-align:center; margin-top:10px; font-weight:bold;"></p>
            </div>
            
            <div>
                <div class="cam-wrapper" id="regCamBox" style="height:350px;">
                    <video id="regVideo" autoplay muted playsinline></video>
                </div>
                <button onclick="startRegCamera()" class="btn btn-info" style="margin-top:15px;">
                    <i class="fas fa-camera"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
                </button>
            </div>
        </div>
    </div>

    <div id="dashboard" class="tab-content">
        <div style="background:#f8f9fa; padding:20px; border-radius:15px; margin-bottom:20px;">
            <div class="grid-layout" style="gap:15px; grid-template-columns: 1fr 1fr 1fr auto;">
                <div><label>‡∏´‡πâ‡∏≠‡∏á</label><input type="text" id="dashClass" value="TestClass"></div>
                <div><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><select id="dashDate"><option value="">-- ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° --</option></select></div>
                <div><label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠</label><input type="text" id="dashSearch" placeholder="..."></div>
                <div style="display:flex; align-items:flex-end;">
                    <button onclick="loadReport()" class="btn btn-primary"><i class="fas fa-search"></i> ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                </div>
            </div>
        </div>
        <div style="overflow-x:auto;">
            <table role="grid">
                <thead id="dashHead"></thead>
                <tbody id="dashBody">
                    <tr><td colspan="5" style="text-align:center; padding:30px; color:#999;">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
    // üî•üî•üî• URL Apps Script ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì üî•üî•üî•
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby5Icavnzqn8PdDznQYGh5H93FgGbru21GKFDuJRyqJEy6sFHHzYnOMNqhsG96NY0B5kg/exec'; 

    const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
    let faceMatcher = null, currentStream = null, isModelReady = false, reportData = null;
    let checkedStudents = new Set();
    let regMode = 'existing'; // 'existing' or 'new'

    // INIT
    window.onload = async () => {
        document.getElementById('scanDate').valueAsDate = new Date();
        try {
            await Promise.all([
                faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
            ]);
            isModelReady = true;
            document.getElementById('aiStatus').innerHTML = '<i class="fas fa-check-circle"></i> AI ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
            document.getElementById('aiStatus').classList.add('ready');
        } catch (e) { console.error(e); }
    };

    // TABS & CAMERA
    function setTab(tabId, event) {
        stopCamera();
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        if(event) event.currentTarget.classList.add('active');
    }

    function stopCamera() {
        if (currentStream) currentStream.getTracks().forEach(t => t.stop());
        document.querySelectorAll('video').forEach(v => v.srcObject = null);
        document.querySelectorAll('canvas').forEach(c => c.remove());
    }

    // --- LOGIC ‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (‡πÉ‡∏´‡∏°‡πà) ---
    function setRegMode(mode, btn) {
        regMode = mode;
        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const searchBox = document.getElementById('existingSearchBox');
        const inpId = document.getElementById('regId');
        const inpName = document.getElementById('regName');

        // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
        inpId.value = ""; inpName.value = "";
        document.getElementById('regStatus').innerHTML = "";

        if (mode === 'existing') {
            searchBox.style.display = 'block'; // ‡πÇ‡∏ä‡∏ß‡πå‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            inpId.readOnly = true;             // ‡∏´‡πâ‡∏≤‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á
            inpName.readOnly = true;           // ‡∏´‡πâ‡∏≤‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á
            inpId.placeholder = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...";
            inpName.placeholder = "‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...";
            inpId.style.backgroundColor = "#f0f2f5";
            inpName.style.backgroundColor = "#f0f2f5";
        } else {
            searchBox.style.display = 'none';  // ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            inpId.readOnly = false;            // ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
            inpName.readOnly = false;          // ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
            inpId.placeholder = "‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà...";
            inpName.placeholder = "‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•...";
            inpId.style.backgroundColor = "#fff";
            inpName.style.backgroundColor = "#fff";
        }
    }

    // SCAN LOGIC
    async function loadStudents() {
        const classId = document.getElementById('scanClassId').value;
        const btn = document.getElementById('btnLoad');
        const orgTxt = btn.innerHTML; btn.innerHTML = 'Loading...'; btn.disabled = true;

        try {
            const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "getStudents", classId }) });
            const data = await res.json();
            if (data.status === "success" && data.students.length > 0) {
                const labeled = data.students.map(s => new faceapi.LabeledFaceDescriptors(s.name, [new Float32Array(JSON.parse(s.descriptors))]));
                faceMatcher = new faceapi.FaceMatcher(labeled, 0.6);
                checkedStudents.clear();
                data.students.forEach(s => { if(s.isChecked) checkedStudents.add(s.name); });
                alert(`‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${data.students.length} ‡∏Ñ‡∏ô`);
                document.getElementById('btnStartScan').disabled = false;
            } else { alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"); }
        } catch (e) { alert("Error"); }
        btn.innerHTML = orgTxt; btn.disabled = false;
    }

    async function startScan() {
        stopCamera();
        const video = document.getElementById('scanVideo');
        const camBox = document.getElementById('scanCamBox');
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
            currentStream = stream; video.srcObject = stream;
            await new Promise(r => video.onloadedmetadata = r); video.play();
            while (video.videoWidth === 0) await new Promise(r => setTimeout(r, 100));

            const canvas = faceapi.createCanvasFromMedia(video); camBox.append(canvas);
            const size = { width: video.offsetWidth, height: video.offsetHeight };
            faceapi.matchDimensions(canvas, size);

            setInterval(async () => {
                if (!isModelReady || video.paused) return;
                const detections = await faceapi.detectAllFaces(video).withFaceLandmarks().withFaceDescriptors();
                const resized = faceapi.resizeResults(detections, size);
                canvas.getContext('2d').clearRect(0,0,canvas.width,canvas.height);

                resized.forEach(d => {
                    let label = "Checking...", boxColor = "#4e54c8";
                    if (faceMatcher) {
                        const best = faceMatcher.findBestMatch(d.descriptor);
                        if (best.label === "unknown") { label = "‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å"; boxColor = "#ffa502"; }
                        else if (checkedStudents.has(best.label)) { label = "‚õî " + best.label + " (‡πÅ‡∏•‡πâ‡∏ß)"; boxColor = "#ff6b6b"; }
                        else { label = "‚úÖ " + best.toString(); boxColor = "#2ecc71"; checkedStudents.add(best.label); logCheckIn(best.label); }
                    }
                    new faceapi.draw.DrawBox(d.detection.box, { label, boxColor, lineWidth:3 }).draw(canvas);
                });
            }, 100);
        } catch (e) { alert("Cam Error"); }
    }

    function logCheckIn(name) {
        const time = new Date().toLocaleTimeString('th-TH');
        const logBox = document.getElementById('scanLog');
        const div = document.createElement('div'); div.className = 'log-item';
        div.innerHTML = `<i class="fas fa-check-circle" style="color:#2ecc71"></i> <div><strong>${name}</strong> <span style="color:#777">(${time})</span></div>`;
        logBox.prepend(div);
        fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "checkIn", classId: document.getElementById('scanClassId').value, date: document.getElementById('scanDate').value, id: name }) });
    }

    // REGISTER LOGIC
    async function findStudentData() {
        const cId = document.getElementById('regClassId').value;
        const sId = document.getElementById('regSearchId').value;
        const btn = event.currentTarget; const orgTxt = btn.innerHTML;
        if(!cId || !sId) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô");
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; btn.disabled = true;

        try {
            const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "findStudent", classId: cId, id: sId }) });
            const data = await res.json();
            if(data.status === "success") {
                document.getElementById('regId').value = data.student.id;
                document.getElementById('regName').value = data.student.name;
                const stat = document.getElementById('regStatus');
                stat.innerHTML = data.student.hasFace ? "‚ö†Ô∏è ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡πâ‡∏ß (‡∏à‡∏∞‡∏ó‡∏±‡∏ö)" : "‚úÖ ‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤)";
                stat.style.color = data.student.hasFace ? "orange" : "green";
                startRegCamera();
            } else { alert("‚ùå " + data.message); }
        } catch(e) { alert("Error"); }
        btn.innerHTML = orgTxt; btn.disabled = false;
    }

    async function startRegCamera() {
        stopCamera();
        const video = document.getElementById('regVideo');
        const camBox = document.getElementById('regCamBox');
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
            currentStream = stream; video.srcObject = stream;
            await new Promise(r => video.onloadedmetadata = r); video.play();
            while (video.videoWidth === 0) await new Promise(r => setTimeout(r, 100));

            const canvas = faceapi.createCanvasFromMedia(video); camBox.append(canvas);
            const size = { width: video.offsetWidth, height: video.offsetHeight };
            faceapi.matchDimensions(canvas, size);

            setInterval(async () => {
                if (!isModelReady || video.paused) return;
                const det = await faceapi.detectSingleFace(video).withFaceLandmarks();
                canvas.getContext('2d').clearRect(0,0,canvas.width,canvas.height);
                if(det) new faceapi.draw.DrawBox(faceapi.resizeResults(det, size).detection.box, { label: "Ready", boxColor: "#4e54c8" }).draw(canvas);
            }, 100);
            document.getElementById('btnReg').disabled = false;
        } catch (e) { alert("Cam Error"); }
    }

    async function registerFace() {
        const video = document.getElementById('regVideo');
        const btn = document.getElementById('btnReg');
        const stat = document.getElementById('regStatus');
        const inpClass = regMode === 'existing' ? document.getElementById('regClassId').value : document.getElementById('scanClassId').value; // ‡∏ñ‡πâ‡∏≤ new ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏´‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ scan ‡πÄ‡∏õ‡πá‡∏ô default ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° input ‡πÅ‡∏¢‡∏Å‡∏Å‡πá‡πÑ‡∏î‡πâ
        
        // *‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î New ‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤ user ‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏ú‡∏°‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å Input ‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà
        // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î New ‡∏ú‡∏°‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å regClassId (‡∏ã‡∏∂‡πà‡∏á‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤) ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î New ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° Input ‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏¢‡∏Å
        // ‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡πà‡∏≤‡∏¢ ‡∏ú‡∏°‡∏à‡∏∞‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ regClassId ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô (‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î Existing ‡∏°‡∏±‡∏ô‡πÇ‡∏ä‡∏ß‡πå, ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î New ‡∏°‡∏±‡∏ô‡∏ã‡πà‡∏≠‡∏ô ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô New)
        
        btn.disabled = true; stat.innerHTML = 'Processing...';
        try {
            const det = await faceapi.detectSingleFace(video).withFaceLandmarks().withFaceDescriptor();
            if (!det) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡πâ‡∏≤");
            
            // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Backend ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á Create/Update ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
            await fetch(SCRIPT_URL, { 
                method: 'POST', 
                body: JSON.stringify({ 
                    action: "register", 
                    classId: document.getElementById('regClassId').value, // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏¢‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö New ‡∏Å‡πá‡πÑ‡∏î‡πâ)
                    id: document.getElementById('regId').value, 
                    name: document.getElementById('regName').value, 
                    prefix: "", no: "", 
                    descriptors: JSON.stringify(Array.from(det.descriptor)) 
                }) 
            });
            stat.innerHTML = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"; stat.style.color = "green";
            setTimeout(() => { stat.innerHTML = ""; btn.disabled = false; }, 2000);
        } catch (e) { stat.innerHTML = "‚ùå " + e.message; stat.style.color = "red"; btn.disabled = false; }
    }

    // REPORT
    async function loadReport() {
        const cls = document.getElementById('dashClass').value;
        const tbody = document.getElementById('dashBody'); tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Loading...</td></tr>';
        try {
            const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "getReport", classId: cls }) });
            reportData = await res.json();
            const sel = document.getElementById('dashDate');
            if (sel.options.length === 1) reportData.dates.forEach(d => sel.add(new Option(d, d)));
            renderTable();
        } catch (e) { tbody.innerHTML = "Error"; }
    }

    function renderTable() {
        const date = document.getElementById('dashDate').value;
        const term = document.getElementById('dashSearch').value.toLowerCase();
        const thead = document.getElementById('dashHead');
        const tbody = document.getElementById('dashBody');
        let html = "";
        const filtered = reportData.students.filter(s => s.name.toLowerCase().includes(term));

        if (date) {
            thead.innerHTML = `<tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (${date})</th></tr>`;
            filtered.forEach(s => {
                const st = s.attendance[date] || "‡∏Ç‡∏≤‡∏î";
                html += `<tr><td>${s.name}</td><td>${st!=='‡∏Ç‡∏≤‡∏î' ? '<span class="badge badge-success">‚úÖ '+st+'</span>' : '<span class="badge badge-danger">‚ùå ‡∏Ç‡∏≤‡∏î</span>'}</td></tr>`;
            });
        } else {
            let h = "<tr><th>‡∏ä‡∏∑‡πà‡∏≠</th>";
            reportData.dates.forEach(d => h += `<th>${d.split('/')[0]}/${d.split('/')[1]}</th>`);
            thead.innerHTML = h + "</tr>";
            filtered.forEach(s => {
                html += `<tr><td>${s.name}</td>`;
                reportData.dates.forEach(d => html += `<td>${(s.attendance[d] && s.attendance[d] !== "‡∏Ç‡∏≤‡∏î") ? '‚úÖ' : '‚ùå'}</td>`);
                html += "</tr>";
            });
        }
        tbody.innerHTML = html;
    }
    document.getElementById('dashDate').onchange = renderTable;
    document.getElementById('dashSearch').onkeyup = renderTable;

</script>
</body>
</html>
