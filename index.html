<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (V2)</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f6f9; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏π‡∏õ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î) */
        .preview-area { position: relative; width: 640px; height: 480px; background: #000; border-radius: 8px; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        img#uploadedImage { max-width: 100%; max-height: 100%; display: none; } 
        canvas { position: absolute; top: 0; left: 0; }
        
        .form-container { width: 300px; display: flex; flex-direction: column; gap: 15px; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        
        .btn-group { display: flex; gap: 10px; }
        button { flex: 1; padding: 10px; border: none; border-radius: 5px; cursor: pointer; color: white; transition: 0.3s; }
        .btn-save { background-color: #28a745; font-size: 16px; padding: 12px; }
        .btn-save:hover { background-color: #218838; }
        .btn-upload { background-color: #007bff; }
        .btn-camera { background-color: #17a2b8; }
        
        /* ‡∏ã‡πà‡∏≠‡∏ô input file ‡πÑ‡∏ß‡πâ */
        #fileInput { display: none; }
        
        #status { margin-top: 10px; text-align: center; font-weight: bold; }
        .success { color: #28a745; } .error { color: #dc3545; }
    </style>
</head>
<body>

    <h2>üìù ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (‡∏Å‡∏•‡πâ‡∏≠‡∏á + ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î)</h2>

    <div class="container">
        <div class="preview-area" id="previewContainer">
            <video id="video" autoplay muted></video>
            <img id="uploadedImage" alt="Upload Preview">
        </div>

        <div class="form-container">
            <div class="btn-group">
                <button class="btn-camera" onclick="useCamera()">üì∑ ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                <button class="btn-upload" onclick="document.getElementById('fileInput').click()">üìÅ ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ</button>
                <input type="file" id="fileInput" accept="image/*" onchange="handleFileUpload(event)">
            </div>
            
            <hr style="width: 100%; border: 0.5px solid #eee;">

            <input type="text" id="classId" placeholder="‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 1-1)">
            <input type="text" id="studentId" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
            <select id="prefix">
                <option value="‡∏î.‡∏ä.">‡∏î.‡∏ä.</option>
                <option value="‡∏î.‡∏ç.">‡∏î.‡∏ç.</option>
                <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option>
                <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
            </select>
            <input type="text" id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
            <input type="number" id="no" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà">
            
            <button id="btnSave" class="btn-save" onclick="registerFace()" disabled>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <div id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• AI...</div>
        </div>
    </div>

    <script>
        // ‚ö†Ô∏è ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby5Icavnzqn8PdDznQYGh5H93FgGbru21GKFDuJRyqJEy6sFHHzYnOMNqhsG96NY0B5kg/exec';
        
        const video = document.getElementById('video');
        const imgPreview = document.getElementById('uploadedImage');
        const btnSave = document.getElementById('btnSave');
        const statusDiv = document.getElementById('status');
        const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';

        let isModelLoaded = false;
        let mode = 'camera'; // 'camera' ‡∏´‡∏£‡∏∑‡∏≠ 'image'

        // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•
        Promise.all([
            faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
            faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
            faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
        ]).then(() => {
            isModelLoaded = true;
            useCamera(); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏•‡πâ‡∏≠‡∏á
        });

        // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á
        function useCamera() {
            mode = 'camera';
            video.style.display = 'block';
            imgPreview.style.display = 'none';
            navigator.mediaDevices.getUserMedia({ video: {} }).then(stream => {
                video.srcObject = stream;
                statusDiv.innerHTML = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á)";
                btnSave.disabled = false;
                startDetectionLoop(); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤
            });
        }

        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            mode = 'image';
            const reader = new FileReader();
            reader.onload = async (e) => {
                imgPreview.src = e.target.result;
                imgPreview.style.display = 'block';
                video.style.display = 'none';
                
                // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
                if (video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                }

                // ‡∏£‡∏≠‡∏£‡∏π‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≠‡∏ö
                imgPreview.onload = () => {
                   detectFaceInImage(); 
                };
            };
            reader.readAsDataURL(file);
            statusDiv.innerHTML = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡πÇ‡∏´‡∏°‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û)";
        }

        // ‡∏•‡∏π‡∏õ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á)
        video.addEventListener('play', () => {
            const canvas = faceapi.createCanvasFromMedia(video);
            canvas.id = 'overlay';
            document.getElementById('previewContainer').append(canvas);
            const displaySize = { width: video.width || 640, height: video.height || 480 };
            faceapi.matchDimensions(canvas, displaySize);

            setInterval(async () => {
                if (mode !== 'camera' || !isModelLoaded) return;
                const detections = await faceapi.detectAllFaces(video).withFaceLandmarks();
                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                faceapi.draw.drawDetections(canvas, resizedDetections);
            }, 100);
        });

        // ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û)
        async function detectFaceInImage() {
            // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå Canvas ‡πÄ‡∏Å‡πà‡∏≤
            const oldCanvas = document.getElementById('overlay');
            if (oldCanvas) oldCanvas.remove();

            const canvas = faceapi.createCanvasFromMedia(imgPreview);
            canvas.id = 'overlay';
            document.getElementById('previewContainer').append(canvas);
            const displaySize = { width: imgPreview.width, height: imgPreview.height };
            faceapi.matchDimensions(canvas, displaySize);

            const detections = await faceapi.detectAllFaces(imgPreview).withFaceLandmarks();
            const resizedDetections = faceapi.resizeResults(detections, displaySize);
            faceapi.draw.drawDetections(canvas, resizedDetections);
        }

        // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà)
        async function registerFace() {
            if (!isModelLoaded) return;
            
            // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Source ‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏≠‡∏≤‡∏à‡∏≤‡∏Å‡πÑ‡∏´‡∏ô
            const inputSource = (mode === 'camera') ? video : imgPreview;

            statusDiv.innerHTML = '<span class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</span>';
            btnSave.disabled = true;

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤
            const detection = await faceapi.detectSingleFace(inputSource).withFaceLandmarks().withFaceDescriptor();

            if (!detection) {
                statusDiv.innerHTML = '<span class="error">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏†‡∏≤‡∏û!</span>';
                btnSave.disabled = false;
                return;
            }

            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏á
            const descriptor = Array.from(detection.descriptor);
            const payload = {
                action: "register",
                classId: document.getElementById('classId').value,
                id: document.getElementById('studentId').value,
                prefix: document.getElementById('prefix').value,
                name: document.getElementById('name').value,
                no: document.getElementById('no').value,
                descriptors: JSON.stringify(descriptor)
            };

            // ‡∏™‡πà‡∏á‡πÑ‡∏õ Google Sheets
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                statusDiv.innerHTML = '<span class="success">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</span>';
                
                // Reset ‡∏ü‡∏≠‡∏£‡πå‡∏°
                document.getElementById('name').value = "";
                document.getElementById('studentId').value = "";
                setTimeout(() => { btnSave.disabled = false; statusDiv.innerHTML = "‡∏û‡∏£‡πâ‡∏≠‡∏°"; }, 2000);
            } catch (err) {
                console.error(err);
                statusDiv.innerHTML = '<span class="error">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</span>';
                btnSave.disabled = false;
            }
        }
    </script>
</body>
</html>
