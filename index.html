<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ AI</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@1.5.10/css/pico.min.css">
    
    <style>
        body { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .nav-tabs { display: flex; gap: 10px; border-bottom: 2px solid #e0e0e0; margin-bottom: 20px; }
        .nav-btn { background: none; border: none; padding: 10px 20px; font-size: 1.1rem; color: #666; cursor: pointer; border-radius: 8px 8px 0 0; }
        .nav-btn.active { background: #1095c1; color: white; font-weight: bold; }
        .tab-content { display: none; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }
        
        /* Camera Box */
        .cam-wrapper { position: relative; width: 640px; height: 480px; background: #000; margin: 0 auto; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { position: absolute; top: 0; left: 0; }

        /* Dashboard Helpers */
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.9em; font-weight: bold; }
        .present { background: #d4edda; color: #155724; }
        .absent { background: #f8d7da; color: #721c24; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <nav>
        <ul><li><strong>üè´ AI Face Attendance</strong></li></ul>
        <ul><li id="aiStatus" style="color:orange;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏°‡∏≠‡∏á AI...</li></ul>
    </nav>

    <div class="nav-tabs">
        <button class="nav-btn active" onclick="setTab('scan')">üì∏ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ (Scan)</button>
        <button class="nav-btn" onclick="setTab('register')">üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (Reg)</button>
        <button class="nav-btn" onclick="setTab('dashboard')">üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î (Report)</button>
    </div>

    <div id="scan" class="tab-content active">
        <article>
            <div class="grid">
                <div>
                    <label>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                    <input type="text" id="scanClassId" value="TestClass">
                    <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</label>
                    <input type="date" id="scanDate">
                    <div class="grid">
                        <button onclick="loadStudents()" class="secondary">1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        <button onclick="startScan()" id="btnStartScan" disabled>2. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô</button>
                    </div>
                </div>
                <div style="height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: 5px;">
                    <h6>üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</h6>
                    <div id="scanLog"></div>
                </div>
            </div>
            <div class="cam-wrapper" id="scanCamBox">
                <video id="scanVideo" autoplay muted></video>
            </div>
        </article>
    </div>

    <div id="register" class="tab-content">
        <article>
            <div class="grid">
                <div>
                    <label>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label><input type="text" id="regClassId" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1-1">
                    <label>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label><input type="text" id="regId">
                    <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input type="text" id="regName">
                    <button onclick="registerFace()" id="btnReg" disabled>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤</button>
                    <p id="regStatus"></p>
                </div>
                <div>
                    <div class="cam-wrapper" id="regCamBox" style="width:100%; height:300px;">
                        <video id="regVideo" autoplay muted></video>
                    </div>
                    <button onclick="startRegCamera()" class="outline" style="margin-top:10px; width:100%;">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                </div>
            </div>
        </article>
    </div>

    <div id="dashboard" class="tab-content">
        <article>
            <div class="grid" style="align-items: end;">
                <label>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô <input type="text" id="dashClass" value="TestClass"></label>
                <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏ß‡πà‡∏≤‡∏á=‡∏î‡∏π‡∏£‡∏ß‡∏°) <select id="dashDate"><option value="">-- ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° --</option></select></label>
                <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ <input type="text" id="dashSearch" placeholder="‡∏ä‡∏∑‡πà‡∏≠..."></label>
                <button onclick="loadReport()">üîç ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏î‡∏π</button>
            </div>
            
            <div id="sumBox" style="display:none; margin: 15px 0;" class="grid">
                <div style="background:#e8f5e9; padding:10px; text-align:center;">‡∏°‡∏≤: <b id="sumP">0</b></div>
                <div style="background:#ffebee; padding:10px; text-align:center;">‡∏Ç‡∏≤‡∏î: <b id="sumA">0</b></div>
            </div>

            <div style="overflow-x:auto;">
                <table role="grid">
                    <thead id="dashHead"></thead>
                    <tbody id="dashBody"><tr><td>‡∏Å‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr></tbody>
                </table>
            </div>
        </article>
    </div>

    <script>
        // üî•üî•üî• ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç URL ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì üî•üî•üî•
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby5Icavnzqn8PdDznQYGh5H93FgGbru21GKFDuJRyqJEy6sFHHzYnOMNqhsG96NY0B5kg/exec';
        
        // ‡πÉ‡∏ä‡πâ CDN ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡πà‡∏≤‡∏¢ (‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô ./models ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)
        const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';

        let faceMatcher = null;
        let currentStream = null;
        let isModelReady = false;
        let reportData = null;

        // --- INIT ---
        window.onload = async () => {
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            document.getElementById('scanDate').valueAsDate = new Date();
            
            try {
                await Promise.all([
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                isModelReady = true;
                document.getElementById('aiStatus').innerHTML = "‚úÖ AI ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
                document.getElementById('aiStatus').style.color = "green";
            } catch (e) {
                document.getElementById('aiStatus').innerHTML = "‚ùå ‡πÇ‡∏´‡∏•‡∏î AI ‡∏û‡∏•‡∏≤‡∏î (‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ô‡πá‡∏ï)";
            }
        };

        // --- TABS ---
        function setTab(tab) {
            stopCamera();
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');
        }

        function stopCamera() {
            if (currentStream) currentStream.getTracks().forEach(t => t.stop());
            document.querySelectorAll('video').forEach(v => v.srcObject = null);
            document.querySelectorAll('canvas').forEach(c => c.remove());
        }

        // --- SCAN LOGIC ---
        async function loadStudents() {
            const classId = document.getElementById('scanClassId').value;
            const btn = event.target; btn.textContent = "‚è≥..."; btn.disabled = true;
            
            try {
                const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "getStudents", classId }) });
                const data = await res.json();
                
                if (data.students && data.students.length > 0) {
                    const labeled = data.students.map(s => new faceapi.LabeledFaceDescriptors(s.name, [new Float32Array(JSON.parse(s.descriptors))]));
                    faceMatcher = new faceapi.FaceMatcher(labeled, 0.6);
                    alert(`‡πÇ‡∏´‡∏•‡∏î ${data.students.length} ‡∏Ñ‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πÅ‡∏Å‡∏ô!`);
                    document.getElementById('btnStartScan').disabled = false;
                } else { alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"); }
            } catch (e) { alert("Error: " + e); }
            btn.textContent = "1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"; btn.disabled = false;
        }

        async function startScan() {
            stopCamera();
            const video = document.getElementById('scanVideo');
            const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
            currentStream = stream;
            video.srcObject = stream;
            
            const canvas = faceapi.createCanvasFromMedia(video);
            document.getElementById('scanCamBox').append(canvas);
            const size = { width: 640, height: 480 };
            faceapi.matchDimensions(canvas, size);

            let checked = new Set();
            
            setInterval(async () => {
                if (!faceMatcher) return;
                const detections = await faceapi.detectAllFaces(video).withFaceLandmarks().withFaceDescriptors();
                const resized = faceapi.resizeResults(detections, size);
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);

                resized.forEach(d => {
                    const best = faceMatcher.findBestMatch(d.descriptor);
                    new faceapi.draw.DrawBox(d.detection.box, { label: best.toString() }).draw(canvas);

                    if (best.label !== "unknown" && !checked.has(best.label)) {
                        checked.add(best.label);
                        logCheckIn(best.label);
                        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÉ‡∏´‡πâ‡∏™‡πÅ‡∏Å‡∏ô‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å 1 ‡∏ô‡∏≤‡∏ó‡∏µ (‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á)
                         setTimeout(() => checked.delete(best.label), 60000); 
                    }
                });
            }, 200);
        }

        function logCheckIn(name) {
            const time = new Date().toLocaleTimeString('th-TH');
            const log = document.getElementById('scanLog');
            log.innerHTML = `<div style="color:green">‚úÖ ${time} - ${name}</div>` + log.innerHTML;
            
            // ‡∏™‡πà‡∏á‡πÑ‡∏õ Backend
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: "checkIn",
                    classId: document.getElementById('scanClassId').value,
                    date: document.getElementById('scanDate').value,
                    id: name
                })
            });
        }

        // --- REGISTER LOGIC ---
        async function startRegCamera() {
            stopCamera();
            const video = document.getElementById('regVideo');
            const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
            currentStream = stream;
            video.srcObject = stream;
            document.getElementById('btnReg').disabled = false;
        }

        async function registerFace() {
            const video = document.getElementById('regVideo');
            const btn = document.getElementById('btnReg');
            const stat = document.getElementById('regStatus');
            btn.disabled = true; stat.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...";

            const det = await faceapi.detectSingleFace(video).withFaceLandmarks().withFaceDescriptor();
            if (!det) { stat.innerHTML = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡πâ‡∏≤"; btn.disabled = false; return; }

            const payload = {
                action: "register",
                classId: document.getElementById('regClassId').value,
                id: document.getElementById('regId').value,
                prefix: "", name: document.getElementById('regName').value, no: "",
                descriptors: JSON.stringify(Array.from(det.descriptor))
            };

            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
                .then(() => { stat.innerHTML = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!"; btn.disabled = false; })
                .catch(e => { stat.innerHTML = "‚ùå Error"; btn.disabled = false; });
        }

        // --- DASHBOARD LOGIC ---
        async function loadReport() {
            const cls = document.getElementById('dashClass').value;
            const tbody = document.getElementById('dashBody');
            tbody.innerHTML = "<tr><td>‚è≥ ‡πÇ‡∏´‡∏•‡∏î...</td></tr>";

            const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "getReport", classId: cls }) });
            reportData = await res.json();
            
            // Update Date Dropdown
            const sel = document.getElementById('dashDate');
            if (sel.options.length === 1) {
                reportData.dates.forEach(d => sel.add(new Option(d, d)));
            }
            renderTable();
        }

        function renderTable() {
            const date = document.getElementById('dashDate').value;
            const term = document.getElementById('dashSearch').value.toLowerCase();
            const thead = document.getElementById('dashHead');
            const tbody = document.getElementById('dashBody');
            const sumBox = document.getElementById('sumBox');
            
            if (!reportData || !reportData.students) return;

            const filtered = reportData.students.filter(s => s.name.toLowerCase().includes(term));
            let html = "";

            if (date) {
                // ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
                sumBox.style.display = "flex";
                thead.innerHTML = `<tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (${date})</th></tr>`;
                let p = 0;
                filtered.forEach(s => {
                    const st = s.attendance[date] || "‡∏Ç‡∏≤‡∏î";
                    const isP = st !== "‡∏Ç‡∏≤‡∏î";
                    if (isP) p++;
                    html += `<tr><td>${s.name}</td><td><span class="status-badge ${isP?'present':'absent'}">${isP?'‚úÖ '+st:'‚ùå ‡∏Ç‡∏≤‡∏î'}</span></td></tr>`;
                });
                document.getElementById('sumP').innerText = p;
                document.getElementById('sumA').innerText = filtered.length - p;
            } else {
                // ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
                sumBox.style.display = "none";
                let h = "<tr><th>‡∏ä‡∏∑‡πà‡∏≠</th>";
                reportData.dates.forEach(d => h += `<th>${d.split('/')[0]}/${d.split('/')[1]}</th>`);
                thead.innerHTML = h + "</tr>";
                
                filtered.forEach(s => {
                    html += `<tr><td>${s.name}</td>`;
                    reportData.dates.forEach(d => {
                        const isP = (s.attendance[d] && s.attendance[d] !== "‡∏Ç‡∏≤‡∏î");
                        html += `<td>${isP?'‚úÖ':'‚ùå'}</td>`;
                    });
                    html += "</tr>";
                });
            }
            tbody.innerHTML = html;
        }

        // Auto trigger render on change
        document.getElementById('dashDate').onchange = renderTable;
        document.getElementById('dashSearch').onkeyup = renderTable;

    </script>
</body>
</html>
