<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ AI</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@1.5.10/css/pico.min.css">
    
    <style>
        body { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .nav-tabs { display: flex; gap: 10px; border-bottom: 2px solid #e0e0e0; margin-bottom: 20px; }
        .nav-btn { background: none; border: none; padding: 10px 20px; font-size: 1.1rem; color: #666; cursor: pointer; border-radius: 8px 8px 0 0; }
        .nav-btn.active { background: #1095c1; color: white; font-weight: bold; }
        .tab-content { display: none; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }
        
        /* Camera Box */
        .cam-wrapper { position: relative; width: 640px; height: 480px; background: #000; margin: 0 auto; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { position: absolute; top: 0; left: 0; }

        /* Dashboard Helpers */
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.9em; font-weight: bold; }
        .present { background: #d4edda; color: #155724; }
        .absent { background: #f8d7da; color: #721c24; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <nav>
        <ul><li><strong>üè´ AI Face Attendance</strong></li></ul>
        <ul><li id="aiStatus" style="color:orange;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏°‡∏≠‡∏á AI...</li></ul>
    </nav>

    <div class="nav-tabs">
        <button class="nav-btn active" onclick="setTab('scan')">üì∏ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ (Scan)</button>
        <button class="nav-btn" onclick="setTab('register')">üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (Reg)</button>
        <button class="nav-btn" onclick="setTab('dashboard')">üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î (Report)</button>
    </div>

    <div id="scan" class="tab-content active">
        <article>
            <div class="grid">
                <div>
                    <label>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                    <input type="text" id="scanClassId" value="TestClass">
                    <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</label>
                    <input type="date" id="scanDate">
                    <div class="grid">
                        <button onclick="loadStudents()" class="secondary">1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        <button onclick="startScan()" id="btnStartScan" disabled>2. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô</button>
                    </div>
                </div>
                <div style="height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: 5px;">
                    <h6>üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</h6>
                    <div id="scanLog"></div>
                </div>
            </div>
            <div class="cam-wrapper" id="scanCamBox">
                <video id="scanVideo" autoplay muted></video>
            </div>
        </article>
    </div>

    <div id="register" class="tab-content">
        <article>
            <div class="grid">
                <div>
                    <label>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label><input type="text" id="regClassId" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1-1">
                    <label>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label><input type="text" id="regId">
                    <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input type="text" id="regName">
                    <button onclick="registerFace()" id="btnReg" disabled>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤</button>
                    <p id="regStatus"></p>
                </div>
                <div>
                    <div class="cam-wrapper" id="regCamBox" style="width:100%; height:300px;">
                        <video id="regVideo" autoplay muted></video>
                    </div>
                    <button onclick="startRegCamera()" class="outline" style="margin-top:10px; width:100%;">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                </div>
            </div>
        </article>
    </div>

    <div id="dashboard" class="tab-content">
        <article>
            <div class="grid" style="align-items: end;">
                <label>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô <input type="text" id="dashClass" value="TestClass"></label>
                <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏ß‡πà‡∏≤‡∏á=‡∏î‡∏π‡∏£‡∏ß‡∏°) <select id="dashDate"><option value="">-- ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° --</option></select></label>
                <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ <input type="text" id="dashSearch" placeholder="‡∏ä‡∏∑‡πà‡∏≠..."></label>
                <button onclick="loadReport()">üîç ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏î‡∏π</button>
            </div>
            
            <div id="sumBox" style="display:none; margin: 15px 0;" class="grid">
                <div style="background:#e8f5e9; padding:10px; text-align:center;">‡∏°‡∏≤: <b id="sumP">0</b></div>
                <div style="background:#ffebee; padding:10px; text-align:center;">‡∏Ç‡∏≤‡∏î: <b id="sumA">0</b></div>
            </div>

            <div style="overflow-x:auto;">
                <table role="grid">
                    <thead id="dashHead"></thead>
                    <tbody id="dashBody"><tr><td>‡∏Å‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr></tbody>
                </table>
            </div>
        </article>
    </div>

    <script>
        // üî•üî•üî• ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç URL ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì üî•üî•üî•
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby5Icavnzqn8PdDznQYGh5H93FgGbru21GKFDuJRyqJEy6sFHHzYnOMNqhsG96NY0B5kg/exec';
        
        // ‡πÉ‡∏ä‡πâ CDN ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡πà‡∏≤‡∏¢ (‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô ./models ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)
        const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';

        let faceMatcher = null;
        let currentStream = null;
        let isModelReady = false;
        let reportData = null;

        // --- INIT ---
        window.onload = async () => {
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            document.getElementById('scanDate').valueAsDate = new Date();
            
            try {
                await Promise.all([
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                isModelReady = true;
                document.getElementById('aiStatus').innerHTML = "‚úÖ AI ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
                document.getElementById('aiStatus').style.color = "green";
            } catch (e) {
                document.getElementById('aiStatus').innerHTML = "‚ùå ‡πÇ‡∏´‡∏•‡∏î AI ‡∏û‡∏•‡∏≤‡∏î (‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ô‡πá‡∏ï)";
            }
        };

        // --- TABS ---
        function setTab(tab) {
            stopCamera();
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');
        }

        function stopCamera() {
            if (currentStream) currentStream.getTracks().forEach(t => t.stop());
            document.querySelectorAll('video').forEach(v => v.srcObject = null);
            document.querySelectorAll('canvas').forEach(c => c.remove());
        }

        // --- SCAN LOGIC ---
        async function loadStudents() {
            const classId = document.getElementById('scanClassId').value;
            const btn = event.target; btn.textContent = "‚è≥..."; btn.disabled = true;
            
            try {
                const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "getStudents", classId }) });
                const data = await res.json();
                
                if (data.students && data.students.length > 0) {
                    const labeled = data.students.map(s => new faceapi.LabeledFaceDescriptors(s.name, [new Float32Array(JSON.parse(s.descriptors))]));
                    faceMatcher = new faceapi.FaceMatcher(labeled, 0.6);
                    alert(`‡πÇ‡∏´‡∏•‡∏î ${data.students.length} ‡∏Ñ‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πÅ‡∏Å‡∏ô!`);
                    document.getElementById('btnStartScan').disabled = false;
                } else { alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"); }
            } catch (e) { alert("Error: " + e); }
            btn.textContent = "1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"; btn.disabled = false;
        }

        async function startScan() {
            // 1. ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏¢‡πà‡∏á‡∏Å‡∏±‡∏ô)
            stopCamera(); 
            
            const video = document.getElementById('scanVideo');
            
            try {
                // 2. ‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
                const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                currentStream = stream;
                video.srcObject = stream;
                
                // 3. ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏°‡∏±‡∏ô‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÜ (Promise wrapper)
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        resolve();
                    };
                });
                
                video.play();

                // 4. *** ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ *** : ‡∏£‡∏≠‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏Ç‡∏ô‡∏≤‡∏î‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏à‡∏∞‡∏°‡∏≤‡∏Ñ‡∏£‡∏ö (‡∏Å‡∏±‡∏ô Error: media has not finished)
                while (video.videoWidth === 0 || video.videoHeight === 0) {
                     await new Promise(r => setTimeout(r, 100)); // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏∏‡∏Å 0.1 ‡∏ß‡∏¥ ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏†‡∏≤‡∏û‡∏à‡∏∞‡∏°‡∏≤
                }

                // --- ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡πà‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏° 100% ---

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á Canvas
                const canvas = faceapi.createCanvasFromMedia(video);
                document.getElementById('scanCamBox').append(canvas);
                
                const displaySize = { width: video.videoWidth, height: video.videoHeight };
                faceapi.matchDimensions(canvas, displaySize);

                const checked = new Set();
                
                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏π‡∏õ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö
                setInterval(async () => {
                    // ‡∏ñ‡πâ‡∏≤ AI ‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏õ‡∏¥‡∏î‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°
                    if (!isModelReady || video.paused || video.ended) return;

                    // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤
                    const detections = await faceapi.detectAllFaces(video).withFaceLandmarks().withFaceDescriptors();
                    
                    // 2. ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠
                    const resizedDetections = faceapi.resizeResults(detections, displaySize);
                    
                    // 3. ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏Å‡πà‡∏≤
                    canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);

                    // 4. ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≠‡∏ö
                    resizedDetections.forEach(d => {
                        let label = "Checking...";
                        let boxColor = "#1e90ff"; // ‡∏™‡∏µ‡∏ü‡πâ‡∏≤ (Default)

                        // ‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏î‡∏π
                        if (faceMatcher) {
                            const bestMatch = faceMatcher.findBestMatch(d.descriptor);
                            
                            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏ï‡∏±‡∏ß‡∏à‡∏£‡∏¥‡∏á (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà unknown)
                            if (bestMatch.label !== "unknown") {
                                label = bestMatch.toString();
                                boxColor = "#00ff00"; // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                                
                                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ (‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô)
                                if (!checked.has(bestMatch.label)) {
                                    checked.add(bestMatch.label);
                                    logCheckIn(bestMatch.label);
                                    // ‡∏Å‡∏±‡∏ô‡∏™‡πÅ‡∏Å‡∏ô‡∏£‡∏±‡∏ß‡πÜ: ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å list ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 1 ‡∏ô‡∏≤‡∏ó‡∏µ
                                    setTimeout(() => checked.delete(bestMatch.label), 60000); 
                                }
                            } else {
                                label = "Unknown";
                                boxColor = "#ff0000"; // ‡∏™‡∏µ‡πÅ‡∏î‡∏á
                            }
                        }

                        // ‡∏™‡∏±‡πà‡∏á‡∏ß‡∏≤‡∏î‡∏•‡∏á‡∏à‡∏≠
                        const drawBox = new faceapi.draw.DrawBox(d.detection.box, { label: label, boxColor: boxColor });
                        drawBox.draw(canvas);
                    });
                }, 100); // ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å 0.1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

            } catch (err) {
                console.error(err);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
            }
        }

        function logCheckIn(name) {
            const time = new Date().toLocaleTimeString('th-TH');
            const log = document.getElementById('scanLog');
            log.innerHTML = `<div style="color:green">‚úÖ ${time} - ${name}</div>` + log.innerHTML;
            
            // ‡∏™‡πà‡∏á‡πÑ‡∏õ Backend
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: "checkIn",
                    classId: document.getElementById('scanClassId').value,
                    date: document.getElementById('scanDate').value,
                    id: name
                })
            });
        }

        // --- REGISTER LOGIC ---
        async function startRegCamera() {
            stopCamera();
            const video = document.getElementById('regVideo');
            const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
            currentStream = stream;
            video.srcObject = stream;
            document.getElementById('btnReg').disabled = false;
        }

        async function registerFace() {
            const video = document.getElementById('regVideo');
            const btn = document.getElementById('btnReg');
            const stat = document.getElementById('regStatus');
            btn.disabled = true; stat.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...";

            const det = await faceapi.detectSingleFace(video).withFaceLandmarks().withFaceDescriptor();
            if (!det) { stat.innerHTML = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡πâ‡∏≤"; btn.disabled = false; return; }

            const payload = {
                action: "register",
                classId: document.getElementById('regClassId').value,
                id: document.getElementById('regId').value,
                prefix: "", name: document.getElementById('regName').value, no: "",
                descriptors: JSON.stringify(Array.from(det.descriptor))
            };

            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
                .then(() => { stat.innerHTML = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!"; btn.disabled = false; })
                .catch(e => { stat.innerHTML = "‚ùå Error"; btn.disabled = false; });
        }

        // --- DASHBOARD LOGIC ---
        async function loadReport() {
            const cls = document.getElementById('dashClass').value;
            const tbody = document.getElementById('dashBody');
            tbody.innerHTML = "<tr><td>‚è≥ ‡πÇ‡∏´‡∏•‡∏î...</td></tr>";

            const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "getReport", classId: cls }) });
            reportData = await res.json();
            
            // Update Date Dropdown
            const sel = document.getElementById('dashDate');
            if (sel.options.length === 1) {
                reportData.dates.forEach(d => sel.add(new Option(d, d)));
            }
            renderTable();
        }

        function renderTable() {
            const date = document.getElementById('dashDate').value;
            const term = document.getElementById('dashSearch').value.toLowerCase();
            const thead = document.getElementById('dashHead');
            const tbody = document.getElementById('dashBody');
            const sumBox = document.getElementById('sumBox');
            
            if (!reportData || !reportData.students) return;

            const filtered = reportData.students.filter(s => s.name.toLowerCase().includes(term));
            let html = "";

            if (date) {
                // ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
                sumBox.style.display = "flex";
                thead.innerHTML = `<tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (${date})</th></tr>`;
                let p = 0;
                filtered.forEach(s => {
                    const st = s.attendance[date] || "‡∏Ç‡∏≤‡∏î";
                    const isP = st !== "‡∏Ç‡∏≤‡∏î";
                    if (isP) p++;
                    html += `<tr><td>${s.name}</td><td><span class="status-badge ${isP?'present':'absent'}">${isP?'‚úÖ '+st:'‚ùå ‡∏Ç‡∏≤‡∏î'}</span></td></tr>`;
                });
                document.getElementById('sumP').innerText = p;
                document.getElementById('sumA').innerText = filtered.length - p;
            } else {
                // ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
                sumBox.style.display = "none";
                let h = "<tr><th>‡∏ä‡∏∑‡πà‡∏≠</th>";
                reportData.dates.forEach(d => h += `<th>${d.split('/')[0]}/${d.split('/')[1]}</th>`);
                thead.innerHTML = h + "</tr>";
                
                filtered.forEach(s => {
                    html += `<tr><td>${s.name}</td>`;
                    reportData.dates.forEach(d => {
                        const isP = (s.attendance[d] && s.attendance[d] !== "‡∏Ç‡∏≤‡∏î");
                        html += `<td>${isP?'‚úÖ':'‚ùå'}</td>`;
                    });
                    html += "</tr>";
                });
            }
            tbody.innerHTML = html;
        }

        // Auto trigger render on change
        document.getElementById('dashDate').onchange = renderTable;
        document.getElementById('dashSearch').onkeyup = renderTable;

    </script>
</body>
</html>
