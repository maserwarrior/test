<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ (AI Face Attendance)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <style>
        /* --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô --- */
        :root {
            --primary: #4e54c8;
            --secondary: #8f94fb;
            --accent: #ff6b6b;
            --success: #2ecc71;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-color: #333;
        }

        body {
            font-family: 'Prompt', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        /* --- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å (Main Card) --- */
        .app-container {
            background: var(--card-bg);
            width: 100%;
            max-width: 1000px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            padding: 30px;
            margin-top: 20px;
        }

        /* --- Header --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 15px;
        }

        h1 { margin: 0; color: var(--primary); font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        .ai-status { font-size: 0.9rem; font-weight: 600; padding: 5px 15px; border-radius: 20px; background: #eee; color: #777; transition: 0.3s; }
        .ai-status.ready { background: #d4edda; color: #155724; }

        /* --- Navigation Tabs --- */
        .nav-tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            background: #f8f9fa;
            padding: 5px;
            border-radius: 15px;
        }

        .nav-btn {
            flex: 1;
            border: none;
            background: transparent;
            padding: 12px;
            font-family: 'Prompt', sans-serif;
            font-size: 1rem;
            color: #666;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .nav-btn:hover { background: rgba(78, 84, 200, 0.1); color: var(--primary); }
        .nav-btn.active {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 4px 15px rgba(78, 84, 200, 0.3);
            font-weight: 600;
        }

        /* --- Content Area --- */
        .tab-content { display: none; animation: slideUp 0.4s ease; }
        .tab-content.active { display: block; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Inputs & Grid --- */
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 0.9rem; }
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: 'Prompt', sans-serif;
            font-size: 1rem;
            transition: 0.3s;
            box-sizing: border-box; /* ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç */
        }
        input:focus { border-color: var(--secondary); outline: none; box-shadow: 0 0 0 3px rgba(143, 148, 251, 0.2); }

        .grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        @media (max-width: 768px) { .grid-layout { grid-template-columns: 1fr; } }

        /* --- Buttons --- */
        .btn {
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Prompt', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(to right, #11998e, #38ef7d); color: white; box-shadow: 0 4px 10px rgba(56, 239, 125, 0.3); }
        .btn-secondary { background: linear-gradient(to right, #ff9966, #ff5e62); color: white; box-shadow: 0 4px 10px rgba(255, 94, 98, 0.3); }
        .btn-info { background: linear-gradient(to right, #4facfe, #00f2fe); color: white; }
        .btn:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; transform: none; }

        /* --- Camera Box --- */
        .cam-wrapper {
            position: relative;
            width: 100%;
            max-width: 640px;
            height: 480px;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            margin: 0 auto;
            border: 4px solid #fff;
        }
        video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        canvas { position: absolute; top: 0; left: 0; z-index: 10; }

        /* --- Log & Tables --- */
        .log-box {
            height: 350px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 10px;
            background: #fafafa;
        }
        .log-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: fadeIn 0.3s;
        }
        .log-item i { color: var(--success); }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #555; font-weight: 600; }
        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; }
        .present { background: #e6fffa; color: #2c7a7b; border: 1px solid #b2f5ea; }
        .absent { background: #fff5f5; color: #c53030; border: 1px solid #feb2b2; }

    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <h1><i class="fas fa-user-check"></i> Face Check <small style="font-size:0.5em; opacity:0.6; margin-left:5px;">System V2</small></h1>
            <div id="aiStatus" class="ai-status"><i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏°‡∏≠‡∏á AI...</div>
        </header>

        <div class="nav-tabs">
            <button class="nav-btn active" onclick="setTab('scan', event)">
                <i class="fas fa-camera"></i> ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ (Scan)
            </button>
            <button class="nav-btn" onclick="setTab('register', event)">
                <i class="fas fa-user-plus"></i> ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (Register)
            </button>
            <button class="nav-btn" onclick="setTab('dashboard', event)">
                <i class="fas fa-chart-bar"></i> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (Report)
            </button>
        </div>

        <div id="scan" class="tab-content active">
            <div class="grid-layout">
                <div>
                    <div class="input-group">
                        <label>üè´ ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                        <input type="text" id="scanClassId" value="TestClass" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á...">
                    </div>
                    <div class="input-group">
                        <label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</label>
                        <input type="date" id="scanDate">
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="loadStudents()" id="btnLoad" class="btn btn-info">
                            <i class="fas fa-cloud-download-alt"></i> 1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </button>
                        <button onclick="startScan()" id="btnStartScan" disabled class="btn btn-primary">
                            <i class="fas fa-play"></i> 2. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô
                        </button>
                    </div>

                    <div style="margin-top: 20px;">
                        <label>üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</label>
                        <div id="scanLog" class="log-box"></div>
                    </div>
                </div>

                <div>
                    <div class="cam-wrapper" id="scanCamBox">
                        <video id="scanVideo" autoplay muted playsinline></video>
                        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:white; z-index:0; text-align:center;">
                            <i class="fas fa-video-slash" style="font-size:3rem; opacity:0.5;"></i>
                            <p>‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</p>
                        </div>
                    </div>
                    <p style="text-align:center; margin-top:10px; color:#777; font-size:0.9rem;">
                        <span style="color:var(--success)">‚óè ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß = ‡∏ú‡πà‡∏≤‡∏ô</span> &nbsp;|&nbsp; 
                        <span style="color:red">‚óè ‡∏™‡∏µ‡πÅ‡∏î‡∏á = ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ã‡πâ‡∏≥</span>
                    </p>
                </div>
            </div>
        </div>

        <div id="register" class="tab-content">
            <div class="grid-layout">
                <div>
                    <h3 style="margin-top:0; color:var(--primary);">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
                    <div class="input-group">
                        <label>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                        <input type="text" id="regClassId" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1-1">
                    </div>
                    <div class="input-group">
                        <label>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                        <input type="text" id="regId" placeholder="‡πÄ‡∏ä‡πà‡∏ô 001">
                    </div>
                    <div class="input-group">
                        <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                        <input type="text" id="regName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
                    </div>
                    
                    <button onclick="registerFace()" id="btnReg" disabled class="btn btn-success" style="background: var(--success); color:white; margin-top:10px;">
                        <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤
                    </button>
                    <p id="regStatus" style="margin-top:10px; font-weight:bold; text-align:center;"></p>
                </div>
                
                <div>
                    <div class="cam-wrapper" id="regCamBox" style="height: 350px;">
                        <video id="regVideo" autoplay muted playsinline></video>
                    </div>
                    <button onclick="startRegCamera()" class="btn btn-info" style="margin-top:15px;">
                        <i class="fas fa-camera"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
                    </button>
                </div>
            </div>
        </div>

        <div id="dashboard" class="tab-content">
            <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <div class="grid-layout" style="gap: 15px; grid-template-columns: 1fr 1fr 1fr auto;">
                    <div>
                        <label>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                        <input type="text" id="dashClass" value="TestClass">
                    </div>
                    <div>
                        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏ß‡∏°)</label>
                        <select id="dashDate"><option value="">-- ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option></select>
                    </div>
                    <div>
                        <button onclick="loadReport()" class="btn btn-secondary" style="margin-top: 26px;">
                            <i class="fas fa-search"></i> ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                        </button>
                    </div>
                </div>
            </div>

            <div style="overflow-x:auto;">
                <table role="grid">
                    <thead id="dashHead"></thead>
                    <tbody id="dashBody">
                        <tr><td colspan="5" style="text-align:center; color:#999; padding:30px;">
                            <i class="fas fa-search" style="font-size:2rem; margin-bottom:10px;"></i><br>
                            ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div> <script>
        // üî•üî•üî• ‡πÉ‡∏™‡πà URL Apps Script ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ üî•üî•üî•
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby5Icavnzqn8PdDznQYGh5H93FgGbru21GKFDuJRyqJEy6sFHHzYnOMNqhsG96NY0B5kg/exec'; 
        
        const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
        let faceMatcher = null, currentStream = null, isModelReady = false, reportData = null;
        let checkedStudents = new Set();

        window.onload = async () => {
            document.getElementById('scanDate').valueAsDate = new Date();
            try {
                await Promise.all([
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                isModelReady = true;
                const statusDiv = document.getElementById('aiStatus');
                statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> AI ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                statusDiv.classList.add('ready');
            } catch (e) { console.error(e); }
        };

        function setTab(tabId, event) {
            stopCamera();
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if(event) event.currentTarget.classList.add('active');
        }

        function stopCamera() {
            if (currentStream) currentStream.getTracks().forEach(t => t.stop());
            document.querySelectorAll('video').forEach(v => v.srcObject = null);
            document.querySelectorAll('canvas').forEach(c => c.remove());
        }

        async function loadStudents() {
            const classId = document.getElementById('scanClassId').value;
            const btn = document.getElementById('btnLoad'); 
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...'; btn.disabled = true;
            try {
                const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "getStudents", classId }) });
                const data = await res.json();
                if (data.status === "success" && data.students.length > 0) {
                    const labeled = data.students.map(s => new faceapi.LabeledFaceDescriptors(s.name, [new Float32Array(JSON.parse(s.descriptors))]));
                    faceMatcher = new faceapi.FaceMatcher(labeled, 0.6);
                    checkedStudents.clear();
                    data.students.forEach(s => { if(s.isChecked) checkedStudents.add(s.name); });
                    alert(`‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${data.students.length} ‡∏Ñ‡∏ô (‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß ${checkedStudents.size} ‡∏Ñ‡∏ô)`);
                    document.getElementById('btnStartScan').disabled = false;
                } else { alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"); }
            } catch (e) { alert("Error: " + e); }
            btn.innerHTML = originalText; btn.disabled = false;
        }

        async function startScan() {
            stopCamera();
            const video = document.getElementById('scanVideo');
            const camBox = document.getElementById('scanCamBox');

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                currentStream = stream;
                video.srcObject = stream;
                await new Promise(r => video.onloadedmetadata = r);
                video.play();
                while (video.videoWidth === 0) await new Promise(r => setTimeout(r, 100));

                const canvas = faceapi.createCanvasFromMedia(video);
                camBox.append(canvas);
                const size = { width: video.videoWidth, height: video.videoHeight };
                faceapi.matchDimensions(canvas, size);

                setInterval(async () => {
                    if (!isModelReady || video.paused || video.ended) return;
                    const detections = await faceapi.detectAllFaces(video).withFaceLandmarks().withFaceDescriptors();
                    const resized = faceapi.resizeResults(detections, size);
                    canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);

                    resized.forEach(d => {
                        let label = "Checking...", boxColor = "#4e54c8";
                        if (faceMatcher) {
                            const best = faceMatcher.findBestMatch(d.descriptor);
                            if (best.label === "unknown") { label = "‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å"; boxColor = "orange"; }
                            else {
                                if (checkedStudents.has(best.label)) {
                                    label = "‚õî " + best.label + " (‡πÅ‡∏•‡πâ‡∏ß)"; boxColor = "#ff6b6b";
                                } else {
                                    label = "‚úÖ " + best.toString(); boxColor = "#2ecc71";
                                    checkedStudents.add(best.label);
                                    logCheckIn(best.label);
                                }
                            }
                        }
                        new faceapi.draw.DrawBox(d.detection.box, { label, boxColor, lineWidth: 3 }).draw(canvas);
                    });
                }, 100);
            } catch (e) { alert("Cam Error: " + e.message); }
        }

        function logCheckIn(name) {
            const time = new Date().toLocaleTimeString('th-TH');
            const logBox = document.getElementById('scanLog');
            const div = document.createElement('div');
            div.className = 'log-item';
            div.innerHTML = `<i class="fas fa-check-circle"></i> <div><strong>${name}</strong><br><small>${time}</small></div>`;
            logBox.prepend(div);
            
            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "checkIn", classId: document.getElementById('scanClassId').value, date: document.getElementById('scanDate').value, id: name }) });
        }

        async function startRegCamera() {
            stopCamera();
            const video = document.getElementById('regVideo');
            const camBox = document.getElementById('regCamBox');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                currentStream = stream; video.srcObject = stream;
                await new Promise(r => video.onloadedmetadata = r); video.play();
                while (video.videoWidth === 0) await new Promise(r => setTimeout(r, 100));

                const canvas = faceapi.createCanvasFromMedia(video); camBox.append(canvas);
                const size = { width: video.videoWidth, height: video.videoHeight };
                faceapi.matchDimensions(canvas, size);

                setInterval(async () => {
                    if (!isModelReady || video.paused) return;
                    const det = await faceapi.detectSingleFace(video).withFaceLandmarks();
                    canvas.getContext('2d').clearRect(0,0,canvas.width,canvas.height);
                    if(det) new faceapi.draw.DrawBox(faceapi.resizeResults(det, size).detection.box, { label: "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å", boxColor: "#4e54c8" }).draw(canvas);
                }, 100);
                document.getElementById('btnReg').disabled = false;
            } catch (e) { alert("Cam Error"); }
        }

        async function registerFace() {
            const video = document.getElementById('regVideo');
            const btn = document.getElementById('btnReg');
            const stat = document.getElementById('regStatus');
            btn.disabled = true; stat.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...'; stat.style.color = "orange";
            try {
                const det = await faceapi.detectSingleFace(video).withFaceLandmarks().withFaceDescriptor();
                if (!det) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡πâ‡∏≤");
                await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "register", classId: document.getElementById('regClassId').value, id: document.getElementById('regId').value, name: document.getElementById('regName').value, prefix: "", no: "", descriptors: JSON.stringify(Array.from(det.descriptor)) }) });
                stat.innerHTML = '<i class="fas fa-check-circle"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'; stat.style.color = "green";
                setTimeout(() => { stat.innerHTML = ""; btn.disabled = false; }, 2000);
            } catch (e) { stat.innerHTML = "‚ùå " + e.message; stat.style.color = "red"; btn.disabled = false; }
        }

        async function loadReport() {
            const cls = document.getElementById('dashClass').value;
            const tbody = document.getElementById('dashBody'); tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">‚è≥ Loading...</td></tr>';
            try {
                const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "getReport", classId: cls }) });
                reportData = await res.json();
                const sel = document.getElementById('dashDate');
                if (sel.options.length === 1) reportData.dates.forEach(d => sel.add(new Option(d, d)));
                renderTable();
            } catch (e) { tbody.innerHTML = "Error"; }
        }

        function renderTable() {
            const date = document.getElementById('dashDate').value;
            const thead = document.getElementById('dashHead');
            const tbody = document.getElementById('dashBody');
            let html = "";
            
            if (date) {
                thead.innerHTML = `<tr><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (${date})</th></tr>`;
                reportData.students.forEach(s => {
                    const st = s.attendance[date] || "‡∏Ç‡∏≤‡∏î";
                    const badgeClass = st !== '‡∏Ç‡∏≤‡∏î' ? 'present' : 'absent';
                    const icon = st !== '‡∏Ç‡∏≤‡∏î' ? '<i class="fas fa-check"></i>' : '<i class="fas fa-times"></i>';
                    html += `<tr><td>${s.name}</td><td><span class="status-badge ${badgeClass}">${icon} ${st}</span></td></tr>`;
                });
            } else {
                let h = "<tr><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>";
                reportData.dates.forEach(d => h += `<th>${d.split('/')[0]}/${d.split('/')[1]}</th>`);
                thead.innerHTML = h + "</tr>";
                reportData.students.forEach(s => {
                    html += `<tr><td>${s.name}</td>`;
                    reportData.dates.forEach(d => {
                         const isPresent = (s.attendance[d] && s.attendance[d] !== "‡∏Ç‡∏≤‡∏î");
                         html += `<td>${isPresent ? '<span class="status-badge present"><i class="fas fa-check"></i></span>' : '<span class="status-badge absent"><i class="fas fa-times"></i></span>'}</td>`;
                    });
                    html += "</tr>";
                });
            }
            tbody.innerHTML = html;
        }
        document.getElementById('dashDate').onchange = renderTable;
    </script>
</body>
</html>
