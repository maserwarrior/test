<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ AI (Final UI)</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@1.5.10/css/pico.min.css">
    
    <style>
        body { max-width: 1200px; margin: 0 auto; padding: 20px; }
        /* Navigation */
        .nav-tabs { display: flex; gap: 10px; border-bottom: 2px solid #e0e0e0; margin-bottom: 20px; }
        .nav-btn { background: none; border: none; padding: 10px 20px; font-size: 1.1rem; color: #666; cursor: pointer; border-radius: 8px 8px 0 0; transition: 0.3s; }
        .nav-btn:hover { background: #f0f0f0; }
        .nav-btn.active { background: #1095c1; color: white; font-weight: bold; }
        .tab-content { display: none; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }
        
        /* Camera Box - ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ã‡πâ‡∏≠‡∏ô‡∏ó‡∏±‡∏ö */
        .cam-wrapper { 
            position: relative; width: 640px; height: 480px; background: #000; margin: 0 auto; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex; justify-content: center; align-items: center;
        }
        video { position: absolute; top:0; left:0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        canvas { position: absolute; top: 0; left: 0; z-index: 2; }

        /* Dashboard Helpers */
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.9em; font-weight: bold; }
        .present { background: #d4edda; color: #155724; }
        .absent { background: #f8d7da; color: #721c24; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <nav style="margin-bottom: 10px;">
        <ul><li><strong>üè´ AI Face Attendance</strong></li></ul>
        <ul><li id="aiStatus" style="color:orange; font-weight:bold;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏°‡∏≠‡∏á AI...</li></ul>
    </nav>

    <div class="nav-tabs">
        <button class="nav-btn active" onclick="setTab('scan', event)">üì∏ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ (Scan)</button>
        <button class="nav-btn" onclick="setTab('register', event)">üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (Reg)</button>
        <button class="nav-btn" onclick="setTab('dashboard', event)">üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î (Report)</button>
    </div>

    <div id="scan" class="tab-content active">
        <article>
            <div class="grid">
                <div>
                    <label>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô <input type="text" id="scanClassId" value="TestClass"></label>
                    <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ <input type="date" id="scanDate"></label>
                    <div class="grid" style="margin-top:20px;">
                        <button onclick="loadStudents()" class="secondary" id="btnLoad">1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        <button onclick="startScan()" id="btnStartScan" disabled>2. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô</button>
                    </div>
                    <p><small>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß=‡∏ú‡πà‡∏≤‡∏ô, ‡∏™‡∏µ‡πÅ‡∏î‡∏á=‡πÄ‡∏ä‡πá‡∏Ñ‡∏ã‡πâ‡∏≥</small></p>
                </div>
                <div style="height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: 5px; background:#f9f9f9;">
                    <h6 style="border-bottom:1px solid #ddd; padding-bottom:5px;">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ (Real-time)</h6>
                    <div id="scanLog"></div>
                </div>
            </div>
            <div class="cam-wrapper" id="scanCamBox" style="margin-top:20px;">
                <video id="scanVideo" autoplay muted playsinline></video>
            </div>
        </article>
    </div>

    <div id="register" class="tab-content">
        <article>
            <div class="grid">
                <div>
                    <header>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</header>
                    <label>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô <input type="text" id="regClassId" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1-1"></label>
                    <label>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô <input type="text" id="regId" placeholder="‡πÄ‡∏ä‡πà‡∏ô 001"></label>
                    <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <input type="text" id="regName" placeholder="‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ"></label>
                    <button onclick="registerFace()" id="btnReg" disabled style="margin-top:20px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</button>
                    <p id="regStatus" style="margin-top:10px; font-weight:bold;"></p>
                </div>
                <div>
                    <div class="cam-wrapper" id="regCamBox" style="width:100%; height:350px;">
                        <video id="regVideo" autoplay muted playsinline></video>
                    </div>
                    <button onclick="startRegCamera()" class="outline" style="margin-top:10px; width:100%;">üì∑ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                     <p><small style="color:#666;">*‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏ö‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</small></p>
                </div>
            </div>
        </article>
    </div>

    <div id="dashboard" class="tab-content">
        <article>
            <div class="grid" style="align-items: end; gap:10px;">
                <label>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô <input type="text" id="dashClass" value="TestClass"></label>
                <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏ß‡πà‡∏≤‡∏á=‡∏î‡∏π‡∏£‡∏ß‡∏°) <select id="dashDate"><option value="">-- ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° --</option></select></label>
                <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ <input type="text" id="dashSearch" placeholder="‡∏ä‡∏∑‡πà‡∏≠..."></label>
                <button onclick="loadReport()" style="margin-bottom: var(--spacing);">üîç ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏î‡∏π</button>
            </div>
            
            <div id="sumBox" style="display:none; margin: 15px 0;" class="grid">
                <div style="background:#e8f5e9; padding:15px; text-align:center; border-radius:8px;">‚úÖ ‡∏°‡∏≤: <b id="sumP" style="font-size:1.2em;">0</b></div>
                <div style="background:#ffebee; padding:15px; text-align:center; border-radius:8px;">‚ùå ‡∏Ç‡∏≤‡∏î: <b id="sumA" style="font-size:1.2em;">0</b></div>
            </div>

            <div style="overflow-x:auto;">
                <table role="grid" class="striped">
                    <thead id="dashHead"></thead>
                    <tbody id="dashBody"><tr><td colspan="5" style="text-align:center;">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏î‡∏π" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr></tbody>
                </table>
            </div>
        </article>
    </div>

    <script>
        // üî•üî•üî• ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç URL ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì üî•üî•üî•
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby5Icavnzqn8PdDznQYGh5H93FgGbru21GKFDuJRyqJEy6sFHHzYnOMNqhsG96NY0B5kg/exec';
        
        // ‡πÉ‡∏ä‡πâ CDN (‡∏ñ‡πâ‡∏≤‡πÄ‡∏ô‡πá‡∏ï‡∏ä‡πâ‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô ./models ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏≠‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏õ‡∏ß‡∏≤‡∏á)
        const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';

        let faceMatcher = null;
        let currentStream = null;
        let isModelReady = false;
        let reportData = null;

        // --- INIT ---
        window.onload = async () => {
            document.getElementById('scanDate').valueAsDate = new Date();
            try {
                await Promise.all([
                    // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏∏‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                isModelReady = true;
                document.getElementById('aiStatus').innerHTML = "‚úÖ AI ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
                document.getElementById('aiStatus').style.color = "#2ecc71";
            } catch (e) {
                console.error(e);
                document.getElementById('aiStatus').innerHTML = "‚ùå ‡πÇ‡∏´‡∏•‡∏î AI ‡∏û‡∏•‡∏≤‡∏î (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï)";
                document.getElementById('aiStatus').style.color = "#e74c3c";
            }
        };

        // --- TABS & CAMERA CONTROL ---
        function setTab(tabId, event) {
            stopCamera(); // ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏ö
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if(event) event.currentTarget.classList.add('active');
        }

        function stopCamera() {
            if (currentStream) currentStream.getTracks().forEach(t => t.stop());
            // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå video source
            document.querySelectorAll('video').forEach(v => { v.srcObject = null; });
            // ‡∏•‡∏ö canvas ‡∏ó‡∏¥‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏î
            document.querySelectorAll('canvas').forEach(c => c.remove());
        }

        // --- LOGIC 1: SCAN (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà: ‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞) ---
        async function loadStudents() {
            const classId = document.getElementById('scanClassId').value;
            const btn = document.getElementById('btnLoad'); btn.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î..."; btn.disabled = true;
            
            try {
                const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "getStudents", classId }) });
                const data = await res.json();
                
                if (data.status === "success" && data.students.length > 0) {
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á LabeledDescriptors ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏≥ Matching
                    const labeled = data.students.map(s => new faceapi.LabeledFaceDescriptors(s.name, [new Float32Array(JSON.parse(s.descriptors))]));
                    faceMatcher = new faceapi.FaceMatcher(labeled, 0.6); // 0.6 ‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
                    alert(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${data.students.length} ‡∏Ñ‡∏ô`);
                    document.getElementById('btnStartScan').disabled = false;
                } else { alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ"); }
            } catch (e) { alert("Error loading data: " + e); }
            btn.textContent = "1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"; btn.disabled = false;
        }

        async function startScan() {
            stopCamera();
            const video = document.getElementById('scanVideo');
            const camBox = document.getElementById('scanCamBox');

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                currentStream = stream;
                video.srcObject = stream;
                
                await new Promise(r => { video.onloadedmetadata = r; });
                video.play();
                // ‡∏£‡∏≠‡∏à‡∏ô‡∏†‡∏≤‡∏û‡∏°‡∏≤‡∏à‡∏£‡∏¥‡∏á
                while (video.videoWidth === 0) await new Promise(r => setTimeout(r, 100));

                const canvas = faceapi.createCanvasFromMedia(video);
                camBox.append(canvas);
                const size = { width: video.videoWidth, height: video.videoHeight };
                faceapi.matchDimensions(canvas, size);

                const checked = new Set(); // ‡∏à‡∏≥‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ

                setInterval(async () => {
                    if (!isModelReady || video.paused || video.ended) return;
                    const detections = await faceapi.detectAllFaces(video).withFaceLandmarks().withFaceDescriptors();
                    const resized = faceapi.resizeResults(detections, size);
                    canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);

                    resized.forEach(d => {
                        let label = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...";
                        let boxColor = "#1e90ff"; // üîµ ‡∏™‡∏µ‡∏ü‡πâ‡∏≤ (Default: Checking)

                        if (faceMatcher) {
                            const best = faceMatcher.findBestMatch(d.descriptor);
                            
                            if (best.label === "unknown") {
                                label = "‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å";
                                boxColor = "#FFA500"; // üü† ‡∏™‡∏µ‡∏™‡πâ‡∏° (Unknown)
                            } else {
                                // ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å
                                if (checked.has(best.label)) {
                                    // üî¥ ‡πÄ‡∏ä‡πá‡∏Ñ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
                                    label = "‚õî ‡πÄ‡∏ä‡πá‡∏Ñ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏ü‡∏£‡∏°)";
                                    boxColor = "#ff0000"; 
                                } else {
                                    // üü¢ ‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏ä‡πá‡∏Ñ‡∏ú‡πà‡∏≤‡∏ô)
                                    label = "‚úÖ " + best.toString();
                                    boxColor = "#00ff00";
                                    checked.add(best.label);
                                    logCheckIn(best.label);
                                }
                            }
                        }
                        new faceapi.draw.DrawBox(d.detection.box, { label, boxColor }).draw(canvas);
                    });
                }, 100);

            } catch (err) { alert("‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + err.message); }
        }

        function logCheckIn(name) {
            const time = new Date().toLocaleTimeString('th-TH');
            const log = document.getElementById('scanLog');
            log.innerHTML = `<div style="color:green; border-bottom:1px dotted #eee; padding:4px;">‚úÖ ${time} - ${name}</div>` + log.innerHTML;
            
            // ‡∏™‡πà‡∏á‡πÑ‡∏õ Backend
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: "checkIn",
                    classId: document.getElementById('scanClassId').value,
                    date: document.getElementById('scanDate').value,
                    id: name
                })
            });
        }

        // --- LOGIC 2: REGISTER (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏≠‡∏ö) ---
        async function startRegCamera() {
            stopCamera();
            const video = document.getElementById('regVideo');
            const camBox = document.getElementById('regCamBox');

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                currentStream = stream;
                video.srcObject = stream;
                
                await new Promise(r => { video.onloadedmetadata = r; });
                video.play();
                while (video.videoWidth === 0) await new Promise(r => setTimeout(r, 100));

                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≠‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Register
                const canvas = faceapi.createCanvasFromMedia(video);
                camBox.append(canvas);
                const size = { width: video.videoWidth, height: video.videoHeight };
                faceapi.matchDimensions(canvas, size);

                setInterval(async () => {
                    if (!isModelReady || video.paused || video.ended) return;
                    // ‡πÉ‡∏ä‡πâ detectSingleFace ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡∏•‡∏∞‡∏Ñ‡∏ô
                    const detection = await faceapi.detectSingleFace(video).withFaceLandmarks();
                    canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                    if (detection) {
                        const resized = faceapi.resizeResults(detection, size);
                        // ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≠‡∏ö‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤
                        new faceapi.draw.DrawBox(resized.detection.box, { label: "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å", boxColor: "#1e90ff" }).draw(canvas);
                    }
                }, 100);

                document.getElementById('btnReg').disabled = false;

            } catch (err) { alert("‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + err.message); }
        }

        async function registerFace() {
            const video = document.getElementById('regVideo');
            const btn = document.getElementById('btnReg');
            const stat = document.getElementById('regStatus');
            
            if(!isModelReady) { stat.innerHTML = "‚ùå AI ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°"; return; }

            btn.disabled = true; stat.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...";
            stat.style.color = "orange";

            try {
                 // ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                const det = await faceapi.detectSingleFace(video).withFaceLandmarks().withFaceDescriptor();
                if (!det) { throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà"); }

                stat.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
                
                const payload = {
                    action: "register",
                    classId: document.getElementById('regClassId').value,
                    id: document.getElementById('regId').value,
                    prefix: "", name: document.getElementById('regName').value, no: "",
                    descriptors: JSON.stringify(Array.from(det.descriptor))
                };

                await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                stat.innerHTML = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"; stat.style.color = "green";
                // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°
                document.getElementById('regId').value = "";
                document.getElementById('regName').value = "";
                setTimeout(() => { stat.innerHTML = ""; btn.disabled = false; }, 3000);

            } catch (e) {
                stat.innerHTML = "‚ùå Error: " + e.message; stat.style.color = "red";
                btn.disabled = false;
            }
        }

        // --- LOGIC 3: DASHBOARD (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
        async function loadReport() {
            const cls = document.getElementById('dashClass').value;
            const tbody = document.getElementById('dashBody');
            tbody.innerHTML = "<tr><td colspan='5'>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>";

            try {
                const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "getReport", classId: cls }) });
                reportData = await res.json();
                
                if(reportData.status === "error") throw new Error(reportData.message);

                // Update Date Dropdown
                const sel = document.getElementById('dashDate');
                if (sel.options.length === 1 && reportData.dates.length > 0) {
                    reportData.dates.forEach(d => sel.add(new Option(d, d)));
                }
                renderTable();
            } catch(e) { tbody.innerHTML = `<tr><td colspan='5' style="color:red">‚ùå Error: ${e.message}</td></tr>`; }
        }

        function renderTable() {
            const date = document.getElementById('dashDate').value;
            const term = document.getElementById('dashSearch').value.toLowerCase();
            const thead = document.getElementById('dashHead');
            const tbody = document.getElementById('dashBody');
            const sumBox = document.getElementById('sumBox');
            
            if (!reportData || !reportData.students) { tbody.innerHTML = "<tr><td colspan='5'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>"; return; }

            const filtered = reportData.students.filter(s => s.name.toLowerCase().includes(term) || String(s.id).includes(term));
            let html = "";

            if (date) {
                sumBox.style.display = "flex";
                thead.innerHTML = `<tr><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (${date})</th></tr>`;
                let p = 0;
                filtered.forEach(s => {
                    const st = s.attendance[date] || "‡∏Ç‡∏≤‡∏î";
                    const isP = st !== "‡∏Ç‡∏≤‡∏î";
                    if (isP) p++;
                    html += `<tr><td>${s.id}</td><td>${s.name}</td><td><span class="status-badge ${isP?'present':'absent'}">${isP?'‚úÖ '+st:'‚ùå ‡∏Ç‡∏≤‡∏î'}</span></td></tr>`;
                });
                document.getElementById('sumP').innerText = p;
                document.getElementById('sumA').innerText = filtered.length - p;
            } else {
                sumBox.style.display = "none";
                let h = "<tr><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠</th>";
                reportData.dates.forEach(d => h += `<th>${d.split('/')[0]}/${d.split('/')[1]}</th>`);
                thead.innerHTML = h + "</tr>";
                
                filtered.forEach(s => {
                    html += `<tr><td>${s.id}</td><td>${s.name}</td>`;
                    reportData.dates.forEach(d => {
                        const isP = (s.attendance[d] && s.attendance[d] !== "‡∏Ç‡∏≤‡∏î");
                        html += `<td style="text-align:center;">${isP?'‚úÖ':'‚ùå'}</td>`;
                    });
                    html += "</tr>";
                });
            }
            tbody.innerHTML = html || "<tr><td colspan='5'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</td></tr>";
        }

        // Auto triggers
        document.getElementById('dashDate').onchange = renderTable;
        document.getElementById('dashSearch').onkeyup = renderTable;
    </script>
</body>
</html>
